<?php

namespace USPC\PageBundle\Entity;

use Doctrine\ORM\EntityRepository;
use AppBundle\Entity\Store;

/**
 * PageRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PageRepository extends EntityRepository
{
    const URL_IS_ALIAS = 'alias';
    const URL_IS_INVALID = 'invalid';
    const ARTICLES_PER_PAGE = 20;
    /**
     * Mark all unused object urls as alias
     *
     * @param  string  $type
     * @param  object  $obj
     * @return void
     * @author Mykola Martynov
     **/
    public function makeAliasUrl($type, $obj)
    {
        if (!$this->isValidObject($obj)) {
            return;
        }

        $em = $this->getEntityManager();
        $query_params = [
                'type' => $type,
                'object_id' => $obj->getId(),
                'url' => $obj->getUrl(),
            ];

        # mark all urls with given {type,object_id}
        $query = $em
            ->createQuery(
                'UPDATE USPCPageBundle:Page p '
                . 'SET p.is_alias = true '
                . 'WHERE p.type = :type and p.object_id = :object_id and p.url != :url'
            )
            ->setParameters($query_params);
        $query->execute();

        # clear for the current object url
        $query = $em
            ->createquery(
                'UPDATE USPCPageBundle:Page p '
                . 'SET p.is_alias = false '
                . 'WHERE p.type = :type AND p.object_id = :object_id and p.url = :url'
            )
            ->setParameters($query_params);
    }

    /**
     * Find page with given object url.
     *
     * @param  string  $type
     * @param  object  $obj
     * @return null|Page
     * @author Mykola Martynov
     **/
    public function findObject($type, $obj)
    {
        if (!$this->isValidObject($obj)) {
            return;
        }

        $page = $this->findOneBy([
                'type' => $type,
                'url' => $obj->getUrl(),
                'object_id' => $obj->getId(),
            ]);

        return $page;
    }

    /**
     * Return true if given object valid to get id/url
     *
     * @return boolean
     * @author Mykola Martynov
     **/
    private function isValidObject($obj)
    {
        return is_object($obj) && method_exists($obj, 'getId') && method_exists($obj, 'getUrl');
    }

    /**
     * Delete all associated urls with the given object
     *
     * @param  string  $type
     * @param  object  $obj
     * @param  int  $obj_id
     *
     * @return void
     * @author Mykola Martynov
     **/
    public function deletePageUrls($type, $obj, $obj_id = null)
    {
        if (!$this->isValidObject($obj) || empty($obj_id) && empty($obj->getId())) {
            return;
        }

        $obj_id = empty($obj->getId) ? $obj_id : $obj->getId();
        $query = $this->getEntityManager()
            ->createQuery(
                'DELETE FROM USPCPageBundle:Page p '
                . 'WHERE p.type = :type and p.object_id = :object_id'
            )
            ->setParameters([
                'type' => $type,
                'object_id' => $obj_id,
            ]);
        $query->execute();
    }

    /**
     * Remove from all menu urls to given object
     *
     * @param string $type
     * @param object $obj
     * @param int $obj_id
     *
     * @return void
     * @author Michael Strohyi
     **/
    public function deleteFromMenus($type, $obj, $obj_id = null)
    {
        if (!$this->isValidObject($obj) || empty($obj_id) && empty($obj->getId())) {
            return;
        }

        # try to get object_id from object, if it is empty get id from arguments
        $obj_id = empty($obj->getId()) ? $obj_id : $obj->getId();

        # find all urls for current object with given type
        $query = $this->getEntityManager()
            ->createQuery(
                'SELECT p.url FROM USPCPageBundle:Page p '
                . 'WHERE p.type = :type and p.object_id = :object_id'
            )
            ->setParameters([
                'type' => $type,
                'object_id' => $obj_id,
            ]);
        $obj_page_urls = $query->getResult();
        $obj_url = $obj->getUrl();

        # return if no url is found and object has no url inside
        if (empty($obj_page_urls) && empty($obj_url)) {
            return;
        }

        # delete all menu-items link to current object (menu-item url is in the list of object urls)
        $item_repo = $this->getEntityManager()->getRepository('AppBundle:MenuItem');
        foreach ($obj_page_urls as $value) {
            if (!empty($value['url'])) {
                $url = $this->getUrlFromRes($value['url']);
                $item_repo->deleteMenuItems($url);
                if ($obj_url === $url) {
                    $obj_url = null;
                }
            }
        }

        if (empty($obj_url)) {
            return;
        }

        # if object url was not in url list from Pages db, delete menu-item linked to this url
        $item_repo->deleteMenuItems($obj_url);
    }

    /**
     * Try to get string from $res
     *
     * @param resource|string $res
     * @return mixed
     * @author Michael Strohyi
     **/
    public function getUrlFromRes($res)
    {
        if (is_resource($res) && get_resource_type($res) == 'stream') {
            return stream_get_contents($res, -1, 0);
        }

        if (is_string($res)) {
            return $res;
        }

        return null;
    }

    /**
     * Return true if $url exists in db, otherwise return array with additional error options
     *
     * @param string $url
     * @return mixed
     * @author Michael Strohyi
     **/
    public function validateURL($url)
    {
        # if url is homepage or empty return true
        if ($url == '/' || empty($url)) {
            return true;
        }

        # search for current url in Page db
        $query = $this->getEntityManager()
            ->createQuery(
                'SELECT p.object_id, p.is_alias, p.type  FROM USPCPageBundle:Page p '
                . 'WHERE p.url = :url'
            )
            ->setParameters([
                'url' => $url,
            ]);
        $result = $query->setMaxResults(1)->getOneOrNullResult();

        # if url is not found in db return error
        if (empty($result)) {
            return ['error' => self::URL_IS_INVALID];
        }

        # if url exists in db and not alias return true
        if (!$result['is_alias']) {
            return true;
        }

        # if url is alias for object try to find not alias url for this object
        $query = $this->getEntityManager()
            ->createQuery(
                'SELECT p.url FROM USPCPageBundle:Page p '
                . 'WHERE p.type = :type and p.object_id = :object_id and p.is_alias = false'
            )
            ->setParameters([
                'type' => $result['type'],
                'object_id' => $result['object_id'],
            ]);
        $result = $query->setMaxResults(1)->getOneOrNullResult();
        
        # if not alias url is found return error with mesage containinig this url, else return true
        return (empty($result)) ? true : ['error' => self::URL_IS_ALIAS, 'new_url' => $this->getUrlFromRes($result['url'])];
    }

    /**
     * Create crosslink to link apm-html page with html page for given $path as a local url
     *
     * @param string $prefix
     * @param string $amp_prefix
     * @param string path
     * @return string
     * @author Michael Strohyi
     **/
    public function createCrossLink($prefix, $amp_prefix, $path)
    {
        if  (!empty($prefix)) {
            $path = substr($path, strlen($prefix));
            $crosslink = ltrim($path, '/');
        } else {
            $crosslink = trim($amp_prefix, '/') . $path;
        }

        return $crosslink;
    }

    /**
     * Return results from $items list for given $page, using $limit items per page. Also return navigation for pagination.
     *
     * @param array $items
     * @param int $page
     * @param  int $limit
     * @return array
     * @author Michael Strohyi
     **/
    public function getResultsForPage($items, $page, $limit = self::ARTICLES_PER_PAGE)
    {
        # return if items is empty
        if (empty($items)) {
            return [$items, null];
        }

        if ($page == 0) {
            return [$this->groupAlphabetically($items), null];
        }

        # create 404 exception if given page is too big and there are no items for this page
        if (($page - 1) * $limit >= count($items)) {
            throw $this->createNotFoundException();
        }

        $navigation = [];
        # add given page into pagination list
        $nav_links[] = $page;
        $last_nav_link = ceil(count($items)/$limit);
        $offset = 0;
        $run = true;
        # add pages near given page into pagintation list if they exist (maximum 5 pages)
        while (count($nav_links) < 5 && $run) {
            $offset++;
            $run = false;
            # add lower page if it exists
            if ($page - $offset > 0) {
                array_unshift($nav_links, $page - $offset);
                $run = true;
            }
            # add higher page if it exists
            if ($page + $offset <= $last_nav_link) {
                $nav_links[] = $page + $offset;
                $run = true;
            }
        }
        # create pagination menu if there are more than one page in pagination list
        if (count($nav_links) != 1) {
            # add prev link into pagination menu if prev page exists
            if ($page != 1) {
                $navigation['prev'] = $page - 1;
            }
            # add pagination list into pagination menu
            $navigation['pages'] = $nav_links;
            # add next link into pagination menu if next page exists
            if ($page != $last_nav_link) {
                $navigation['next'] = $page + 1;
            }
        }

        return [array_slice($items, ($page - 1) * $limit, $limit), $navigation];
    }

    /**
     * Return results from $articles and $stores lists for given $page, using $limit items per page
     *
     * @param array $articles
     * @param array $stores
     * @param  int $limit
     * @return array
     * @author Michael Strohyi
     **/
    public function getMixedResultsForPage($articles, $stores, $limit = self::ARTICLES_PER_PAGE)
    {
        $articles_count = $articles_all_count = count($articles);
        $stores_count = $stores_all_count = count($stores);
        # if total count of stores and articles are more than limit
        if ($articles_count + $stores_count > $limit) {
            # remove extra results of search
            if ($stores_count < $limit / 2) {
                $articles_count = $limit - $stores_count;
            } elseif ($articles_count < $limit / 2) {
                $stores_count = $limit - $articles_count;
            } else {
                $articles_count = $stores_count = $limit / 2;
            }

            $articles = array_slice($articles, 0, $articles_count);
            $stores = array_slice($stores, 0, $stores_count);
        }

        return ['articles' => $articles, 'stores' => $stores, 'articles_count' => $articles_all_count, 'stores_count' => $stores_all_count];
    }


    /**
     * Return list off all articles with given $type ordered by header and grouped alphabetically if given simple_list param is 0
     *
     * @param array $items
     * @return array
     * @author Michael Strohyi
     **/
    public function groupAlphabetically($items)
    {
        $res = array_fill_keys(['#', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'], []);
        if (empty($items)) {
            return $res;
        }
        # analize type of items and set necessary variables according to item's type
        switch (get_class($items[0])) {
            case 'AppBundle\Entity\Article':
                $method = 'getHeader';
                break;

            case 'AppBundle\Entity\Store':
                $method = 'getName';
                break;

            default:
                # return if type of items is unknown
                return $res;
        }

        if (!method_exists($items[0], $method)) {
            return $res;
        }

        foreach ($items as $item) {
            $first_letter = strtolower(substr($item->$method(), 0, 1));
            if (!ctype_alpha($first_letter)) {
                $res['#'][] = $item;
            } else {
                $res[$first_letter][] = $item;
            }
        }

        return $res;
    }

    /**
     * Search given url in Page db. Return found object and flag, if stores postfix was added to find object or not
     *
     * @param string $url
     * @return array
     * @author Michael Strohyi
     **/
    public function findPageByUrl($url)
    {
        if (empty($url)) {
            return [null, false];
        }

        $stores_postfix = Store::URL_POSTFIX;
        $added_postfix = false;
        # try to find page object with given url
        $res = $this->findOneByUrl($url);
        # if object is not found and stores_postfix is absent at the end of given url
        if (empty($res) && strpos($url, $stores_postfix) !== strlen($url) - strlen($stores_postfix)) {
            # try to find page object by url with stores_postfix added to the end
            $res = $this->findOneByUrl($url . $stores_postfix);
            $added_postfix = true;
        }

        return [$res, $added_postfix];
    }
}
